<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VOLT Wall</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0d0d0d;
      color: #f1f1f1;
    }

    header {
      background-color: #1a1a1a;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: #00ffff;
      position: relative;
    }

    .online-counter {
      position: absolute;
      right: 20px;
      top: 1.2rem;
      font-size: 0.9rem;
      color: #999;
    }

    .feed {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .post {
      background-color: #1e1e1e;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,255,255,0.1);
      position: relative;
    }

    .post h3 {
      margin: 0 0 0.5rem 0;
      color: #00ffff;
    }

    .post p {
      margin: 0;
    }

    .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff4d4d;
      border: none;
      color: white;
      border-radius: 5px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .add-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #00ffff;
      color: #000;
      border: none;
      border-radius: 50px;
      padding: 0.8rem 1.2rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0,255,255,0.5);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #1e1e1e;
      padding: 1.5rem;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      position: relative;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      margin-bottom: 1rem;
      padding: 0.5rem;
      border-radius: 5px;
      border: none;
      background-color: #2c2c2c;
      color: #fff;
    }

    .modal-content button {
      background-color: #00ffff;
      color: #000;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #999;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    VOLT Wall
    <div class="online-counter" id="online">Online: 0</div>
  </header>

  <div class="feed" id="feed"></div>

  <button class="add-button" onclick="openModal()">Добавить пост</button>

  <div class="modal" id="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">×</button>
      <input type="text" id="project" placeholder="Название проекта" />
      <textarea id="content" rows="4" placeholder="Текст поста"></textarea>
      <button onclick="submitPost()">Опубликовать</button>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://evfvvwqwudkrsmjcjysc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2ZnZ2d3F3dWRrcnNtamNqeXNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyNTUyMTQsImV4cCI6MjA2MjgzMTIxNH0.GkqqxPCkL5WbJKZOatC3c-PdwqYUy1lX12Ex6bn2aKM'
    );

    const feed = document.getElementById('feed');
    const modal = document.getElementById('modal');
    let myPostIds = JSON.parse(localStorage.getItem('myPostIds') || '[]');

    function renderPost(id, project, content) {
      const post = document.createElement('div');
      post.className = 'post';
      post.id = `post-${id}`;
      post.innerHTML = `
        <h3>${project}</h3>
        <p>${content}</p>
        ${myPostIds.includes(id) ? `<button class="delete-btn" onclick="deletePost('${id}')">Удалить</button>` : ''}
      `;
      feed.insertBefore(post, feed.firstChild);
    }

    async function loadPosts() {
      const { data, error } = await supabaseClient.from('posts').select('*').order('id', { ascending: false });
      if (error) {
        alert('Ошибка загрузки постов: ' + error.message);
        return;
      }
      feed.innerHTML = '';
      data.forEach(p => renderPost(p.id, p.project, p.content));
    }

    async function submitPost() {
      const project = document.getElementById('project').value.trim();
      const content = document.getElementById('content').value.trim();
      if (!project || !content) {
        alert('Пожалуйста, заполните все поля');
        return;
      }

      const { data, error } = await supabaseClient.from('posts').insert([{ project, content }]).select();
      if (error) {
        alert('Ошибка при публикации: ' + error.message);
        return;
      }

      const newId = data[0].id;
      myPostIds.push(newId);
      localStorage.setItem('myPostIds', JSON.stringify(myPostIds));

      closeModal();
      document.getElementById('project').value = '';
      document.getElementById('content').value = '';
      await loadPosts();
    }

    async function deletePost(id) {
      if (!myPostIds.includes(Number(id))) {
        alert('Вы не можете удалить чужой пост.');
        return;
      }

      const { error } = await supabaseClient.from('posts').delete().eq('id', id);
      if (error) {
        alert('Ошибка при удалении: ' + error.message);
        return;
      }

      const el = document.getElementById(`post-${id}`);
      if (el) el.remove();
    }

    function openModal() {
      modal.style.display = 'flex';
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    window.onclick = function(e) {
      if (e.target === modal) closeModal();
    }

    function updateOnlineUsers() {
      const onlineCount = Math.floor(Math.random() * 21) + 5;
      document.getElementById('online').innerText = `Online: ${onlineCount}`;
    }

    setInterval(updateOnlineUsers, 5000);
    updateOnlineUsers();

    supabaseClient
      .channel('public:posts')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, payload => {
        if (payload.eventType === 'INSERT') {
          renderPost(payload.new.id, payload.new.project, payload.new.content);
        }
        if (payload.eventType === 'DELETE') {
          const el = document.getElementById(`post-${payload.old.id}`);
          if (el) el.remove();
        }
      })
      .subscribe();

    loadPosts();
  </script>
</body>
</html>
